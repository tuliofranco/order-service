name: CI - Testes backend

on:
  pull_request:
    branches:
      - "*"
    paths:
      - "backend/**"
      - ".config/**"
      - ".github/workflows/test.yml"
      - "global.json"
      - "Directory.Build.*"
      - "*/Directory.Build.*"
  workflow_dispatch: {}

jobs:
  tests:
    runs-on: ubuntu-latest

    # Testcontainers precisa de Docker disponível. O runner ubuntu-latest já vem com Docker,
    # então a gente só garante algumas env vars pra evitar problemas de permissão / cleanup.
    env:
      DOTNET_CLI_TELEMETRY_OPTOUT: 1
      TESTCONTAINERS_RYUK_DISABLED: true
      TESTCONTAINERS_CHECKS_DISABLE: true

    steps:
      # 1. Checkout do código
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Instalação do .NET (usa a mesma versão que você tá usando localmente: net9.0)
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            9.0.109

      - name: Restore
        run: dotnet restore backend/OrderService.sln

      - name: Build
        run: dotnet build backend/OrderService.sln --configuration Release --no-restore

      - name: Test with coverage
        run: dotnet test backend/OrderService.sln --configuration Release --no-build --collect:"XPlat Code Coverage"

      - name: Restore dotnet tools
        run: dotnet tool restore

      - name: Generate coverage report
        run: |
          dotnet tool run reportgenerator \
            "-reports:backend/tests/**/TestResults/**/coverage.cobertura.xml" \
            "-targetdir:coverage-report" \
            "-reporttypes:HtmlSummary;Html"

      # 8. Publica o relatório como artifact do job (fica pra download no PR)
      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage-report
          if-no-files-found: error
